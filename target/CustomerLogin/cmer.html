<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=yes">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-touch-fullscreen" content="no">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="no">
    <title>实名认证</title>
    <link rel="stylesheet" href="/skin/css/baitiao/Verifiy_info.css"/>
    <script type="text/javascript" src="/skin/js/jquery-1.7.2.min.js"></script>
    <script src="/skin/2018public/js/layer/layer.js"></script>
</head>

<body>
<div class="header-title">
    <div class="title-img" onclick="history.go(-1);">
    </div>
    实名认证
</div>
<div class="certification_box">
    <div class="title_tips">
        请务必提供清晰的身份证正反面
    </div>
    <div class="upload_idcard">
        <div class="idcard_zheng">
            <img src="/attachment/2018/1225/8ac3bmyawd.png" class="id_zheng" onclick="idzheng()">
            <input type="file" name="idcard_front" class="idcard_front" id="idcard_front" style="visibility: hidden;"
                   accept="image/*" capture="camera">
        </div>
        <div class="idcard_fan">
            <img src="/attachment/2018/1225/gr9v1lp5dz.png" class="id_fan" onclick="idfan()">
            <input type="file" name="idcard_back" class="idcard_back" id="idcard_back" style="visibility: hidden;"
                   accept="image/*" capture="camera">
        </div>
    </div>
    <div class="notice_tips">
        请认真核对您的身份信息，若有误请点击上图重新拍摄
    </div>
    <form class="form-ipt" id="dataform">
        <div class="input-group">
            <label>
                证件号码
            </label>
            <input type="text" placeholder="" name="idcard_no" value="350521199303137574" readonly>
        </div>
        <div class="input-group">
            <label>
                证件有效期
            </label>
            <input type="text" placeholder="" name="valid_date" value="20100813-20200813" readonly>
        </div>
        <div class="input-group">
            <label>
                姓名
            </label>
            <input type="text" placeholder="" name="realname" value="吴扬" readonly>
        </div>
        <div class="input-group">
            <label>
                签发机关
            </label>
            <input type="text" placeholder="" name="issued_by" value="泉州市公安局泉港分局" readonly>
        </div>
        <input type="hidden" name="nianling" value="25">
        <input type="hidden" name="address" value="福建省泉州市泉港区南埔镇仙境村下楼尾29号">
        <input type="hidden" name="idcard_zheng" value="/attachment/2018/1225/8ac3bmyawd.png">
        <input type="hidden" name="idcard_fan" value="/attachment/2018/1225/gr9v1lp5dz.png">
    </form>
    <!--下一步-->
    <div class="next_step">
        <a href="javascript:void(0)" onclick="nextstep()">下一步</a>
    </div>
</div>
</body>
<script>
    $(function () {
        function picCompressdemo(className, imgtype) {
            var size = 1920;
            var imgtype = arguments[1] ? arguments[1] : false;
            $(document).on('change', '.' + className, function () {
                layer.msg('上传中，请稍等', {icon: 4});
                var _this = $('input[type=file][name=' + className + ']')[0];
                _file = _this.files[0];
                fileType = _file.type;
                if (/image\/\w+/.test(fileType)) {

                    var fileReader = new FileReader();

                    fileReader.readAsDataURL(_file);
                    fileReader.onload = function (event) {
                        var result = event.target.result;   //返回的dataURL
                        var image = new Image();
                        image.src = result;
                        image.onload = function () {  //创建一个image对象，给canvas绘制使用
                            var cvs = document.createElement('canvas');
                            var scale = 1;
                            if (this.width > size || this.height > size) {  //600只是示例，可以根据具体的要求去设定
                                if (this.width > this.height) {
                                    scale = size / this.width;
                                } else {
                                    scale = size / this.height;
                                }
                            }
                            cvs.width = this.width * scale;
                            cvs.height = this.height * scale;     //计算等比缩小后图片宽高
                            var ctx = cvs.getContext('2d');
                            ctx.drawImage(this, 0, 0, cvs.width, cvs.height);
                            var newImageData = cvs.toDataURL(fileType, 0.8);   //重新生成图片，<span style="font-family: Arial, Helvetica, sans-serif;">fileType为用户选择的图片类型</span

                            var sendData = newImageData.replace("data:" + fileType + ";base64,", '');
                            $.ajax({
                                url: '/carFamilywx.php?mod=new_baitiao&action=upload',
                                data: {'imgcode': sendData, 'imgtype': imgtype},
                                type: 'post',
                                dataType: 'json',
                                success: function (res) {
                                    if (imgtype == 'idcard_front') {
                                        idcard_front_callback(res)
                                    } else if (imgtype == 'idcard_back') {
                                        idcard_back_callback(res)
                                    }
                                }
                            });
                            $('.' + className).val('');
                        }
                    }
                } else {
                    alert('请选择图片格式文件');
                    return false;
                }
            })
        }

        picCompressdemo('idcard_front', 'idcard_front');
        picCompressdemo('idcard_back', 'idcard_back');
    })

    function nextstep() {
        var form = $("#dataform").serialize();
//			form='idcard_no=411282198710033157&valid_date=20170623-20370623&realname=%E9%AB%98%E5%8D%AB%E6%98%8E&issued_by=%E7%81%B5%E5%AE%9D%E5%B8%82%E5%85%AC%E5%AE%89%E5%B1%80&nianling=31&address=%E6%B2%B3%E5%8D%97%E7%9C%81%E7%81%B5%E5%AE%9D%E5%B8%82%E7%84%A6%E6%9D%91%E9%95%87%E8%BE%9B%E5%BA%84%E6%9D%91%E9%AB%98%E5%BA%842%E7%BB%845%E5%8F%B7&idcard_zheng=attachment%2F2018%2F1115%2F7ntutdxatr.png&idcard_fan=attachment%2F2018%2F1115%2Fd88osfl7jh.png';
        $.ajax({
            url: "carFamilywx.php?mod=new_baitiao&action=save_step1",
            data: form,
            type: 'post',
            dataType: 'json',
            success: function (res) {
                if (res.code == 1) {
                    location.href = 'carFamilywx.php?mod=new_baitiao&action=verify_person'
                } else {
                    layer.msg(res.msg);
                }
            },
            error: function (res) {
                layer.msg('发生了一个错误请刷新页面');
            }
        })
    }

    function idzheng() {
        $('.idcard_front').click();
    }

    function idfan() {
        $('.idcard_back').click();
    }

    function idcard_front_callback(res) {
        if (res.code != 1) {
            layer.msg(res.msg);
        } else {
            var d = res.data;
            $("input[name=nianling]").val(d.nianling);
            $("input[name=address]").val(d.address);
            $("input[name=realname]").val(d.realname);
            $("input[name=idcard_no]").val(d.idcard_no);
            $("input[name=idcard_zheng]").val(d.imgurl);
            $(".id_zheng").attr('src', d.imgurl);
        }
    }

    function idcard_back_callback(res) {
        if (res.code != 1) {
            layer.msg(res.msg);
        } else {
            var d = res.data;
            $("input[name=valid_date]").val(d.valid_date);
            $("input[name=issued_by]").val(d.issued_by);
            $("input[name=idcard_fan]").val(d.imgurl);
            $(".id_fan").attr('src', d.imgurl);
        }
    }
</script>
</html>